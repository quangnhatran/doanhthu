<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Doanh Thu Bán Gà</title>
  <style>
    :root{
      --bg:#0b1220; --muted:#94a3b8; --text:#e2e8f0;
      --danger:#fb7185; --ok:#34d399;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, #1b2a55 0%, transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, #123a52 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }
    .wrap{max-width:1100px; margin:28px auto; padding:0 16px;}
    h1{margin:0 0 14px; font-size:22px; letter-spacing:.2px}
    .grid{display:grid; gap:14px; grid-template-columns: 1fr;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .muted{color:var(--muted)}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}

    /* Form doanh thu: thêm Tên KH + Lịch âm => 12 ô */
    .row{
      display:grid; gap:10px;
      grid-template-columns: repeat(12, 1fr);
      align-items:end
    }

    .order-grid{display:grid; gap:10px; grid-template-columns: repeat(4, 1fr); align-items:end}

    input, select, textarea{
      width:100%; padding:10px 10px;
      border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-family: inherit;
      font-size:16px; /* tránh iOS auto-zoom */
    }
    textarea{min-height:40px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(56,189,248,.7);
      box-shadow:0 0 0 3px rgba(56,189,248,.15)
    }

    .btns{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    button{
      border:none; cursor:pointer; border-radius:10px;
      padding:10px 12px; font-weight:600;
      background: rgba(56,189,248,.14); color: #cbefff;
      border:1px solid rgba(56,189,248,.25);
    }
    button:hover{filter:brightness(1.08)}
    .danger{background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.25); color:#ffd1d9}
    .ok{background: rgba(52,211,153,.14); border-color: rgba(52,211,153,.25); color:#d7ffee}
    .ghost{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color:#e2e8f0}
    .btn-mini{
      padding:7px 10px;
      font-size:13px;
      border-radius:9px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      margin-right:8px;
      white-space:nowrap;
    }

    .table-wrap{overflow:auto; border-radius:12px; border:1px solid rgba(255,255,255,.10)}
    table{width:100%; border-collapse:collapse; min-width:1500px; background: rgba(0,0,0,.18)}
    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:12px; background: rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      backdrop-filter: blur(6px);
    }
    tbody td{
      padding:12px; border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:middle;
    }
    tbody tr:hover{background: rgba(255,255,255,.03)}
    .num{text-align:right; font-variant-numeric: tabular-nums;}

    .totalbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px; border:1px dashed rgba(255,255,255,.18);
      border-radius:12px; background: rgba(0,0,0,.18);
    }
    .totalbar .big{font-size:18px; font-weight:800}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--muted); font-size:12px;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.45}
    .section-title{display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin:0 0 10px}
    .section-title h2{margin:0; font-size:16px}
    .section-title .muted{font-size:12px}

    @media (max-width: 900px){
      .row{grid-template-columns: 1fr;}
      .order-grid{grid-template-columns: 1fr;}
      .btns{justify-content:stretch}
      button{flex:1}
      table{min-width:1400px;}
    }

    /* ==== iPhone X (375x812, DPR 3) - tối ưu riêng ==== */
    @media only screen
      and (device-width: 375px)
      and (device-height: 812px)
      and (-webkit-device-pixel-ratio: 3) {

      .wrap{ margin: 14px auto; padding: 0 12px; }
      h1{font-size: 18px; margin-bottom: 12px;}
      .card{padding: 12px; border-radius: 12px;}

      .row, .order-grid{
        grid-template-columns: 1fr;
        gap: 10px;
        align-items: stretch;
      }

      .btns{width:100%; justify-content:stretch; gap:10px}
      button{
        width:100%;
        padding: 12px 12px;
        font-size: 15px;
        border-radius: 12px;
      }

      .totalbar{
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .totalbar .big{font-size: 18px;}
      .pill{width:100%; justify-content: space-between; padding: 8px 10px;}

      table{min-width:1400px;}
      thead th, tbody td{padding:10px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Doanh Thu Bán Gà</h1>

    <div class="grid">
      <!-- ====== DOANH THU (số con + kg + 2 đơn giá + tên KH + lịch âm) ====== -->
      <div class="card" id="revenueCard">
        <div class="row">
          <div>
            <label for="date">Ngày (Dương lịch)</label>
            <input id="date" type="date" />
          </div>

          <div>
            <label for="customerName">Tên khách hàng</label>
            <input id="customerName" type="text" placeholder="Ví dụ: Anh Nam" />
          </div>

          <div>
            <label for="lunarDate">Lịch âm (VN)</label>
            <input id="lunarDate" type="text" placeholder="Ví dụ: 15/01/2026" />
          </div>

          <div>
            <label for="roosterCount">Gà trống (con)</label>
            <input id="roosterCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="roosterKg">Gà trống (kg)</label>
            <input id="roosterKg" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="roosterPrice">Đơn giá trống (VND/kg)</label>
            <input id="roosterPrice" type="number" min="0" step="1000" placeholder="Ví dụ: 120000" />
          </div>

          <div>
            <label for="henCount">Gà mái (con)</label>
            <input id="henCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="henKg">Gà mái (kg)</label>
            <input id="henKg" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="henPrice">Đơn giá mái (VND/kg)</label>
            <input id="henPrice" type="number" min="0" step="1000" placeholder="Ví dụ: 110000" />
          </div>

          <div>
            <label>Tổng số gà</label>
            <input id="totalCount" type="text" disabled value="0 con" />
          </div>
          <div>
            <label>Tổng kg</label>
            <input id="totalKg" type="text" disabled value="0 kg" />
          </div>
          <div>
            <label>Thành tiền</label>
            <input id="amount" type="text" disabled value="0 ₫" />
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap">
          <div class="pill">Tính tiền: <b>(kg trống × giá trống) + (kg mái × giá mái)</b></div>
          <div class="btns">
            <button class="ok" id="addBtn">+ Thêm dòng</button>
            <button class="ghost" id="cancelEditBtn" style="display:none">Huỷ sửa</button>
            <button id="exportBtn">Xuất CSV</button>
            <button class="danger" id="clearBtn">Xoá tất cả</button>
          </div>
        </div>

        <div class="hint" id="editHint" style="display:none">
          Bạn đang <b>sửa</b> một dòng. Nhấn <b>Cập nhật</b> để lưu, hoặc <b>Huỷ sửa</b>.
        </div>

        
      </div>

      <div class="card">
        <div class="totalbar">
          <div>
            <div class="muted">Tổng danh thu</div>
            <div class="big" id="grandTotal">0 ₫</div>
          </div>
          <div class="pill">
            Tổng:
            <b id="grandCount">0</b> con · <b id="grandKg">0</b> kg
            (Trống <b id="grandRoosterCount">0</b> con/<b id="grandRoosterKg">0</b> kg ·
             Mái <b id="grandHenCount">0</b> con/<b id="grandHenKg">0</b> kg)
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ngày (DL)</th>
                <th>Lịch âm</th>
                <th>Khách hàng</th>

                <th class="num">Trống (con)</th>
                <th class="num">Trống (kg)</th>
                <th class="num">Giá trống</th>

                <th class="num">Mái (con)</th>
                <th class="num">Mái (kg)</th>
                <th class="num">Giá mái</th>

                <th class="num">Tổng con</th>
                <th class="num">Tổng kg</th>
                <th class="num">Thành tiền</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ====== NOTE ĐẶT HÀNG ====== -->
      <div class="card" id="orderCard">
        <div class="section-title">
          <h2>Note đặt hàng</h2>
          <div class="muted">Lưu danh sách khách đặt / ghi chú giao hàng</div>
        </div>

        <div class="order-grid">
          <div>
            <label for="orderDate">Ngày đặt</label>
            <input id="orderDate" type="datetime-local"/>
          </div>
          <div>
            <label for="customer">Tên khách</label>
            <input id="customer" type="text" placeholder="Ví dụ: Anh Nam"/>
          </div>
          <div>
            <label for="phone">SĐT</label>
            <input id="phone" type="tel" placeholder="Ví dụ: 09xxxxxxxx"/>
          </div>
          <div>
            <label for="status">Trạng thái</label>
            <select id="status">
              <option value="Mới">Mới</option>
              <option value="Đang xử lý">Đang xử lý</option>
              <option value="Đã giao">Đã giao</option>
              <option value="Huỷ">Huỷ</option>
            </select>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="orderContent">Nội dung đặt (trống/mái, con/kg, giờ giao...)</label>
            <textarea id="orderContent" placeholder="Ví dụ: Trống 2 con (3.2kg), Mái 1 con (1.6kg), giao 18:30"></textarea>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="orderNote">Ghi chú</label>
            <textarea id="orderNote" placeholder="Ví dụ: Khách trả tiền mặt, gọi trước 10 phút"></textarea>
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap">
          <div class="pill">Tổng đơn: <b id="orderCount">0</b></div>
          <div class="btns">
            <button class="ok" id="addOrderBtn">+ Thêm note</button>
            <button class="ghost" id="cancelOrderEditBtn" style="display:none">Huỷ sửa</button>
            <button id="exportOrderBtn">Xuất CSV</button>
            <button class="danger" id="clearOrderBtn">Xoá tất cả</button>
          </div>
        </div>

        <div class="hint" id="orderEditHint" style="display:none">
          Bạn đang <b>sửa</b> một note. Nhấn <b>Cập nhật</b> để lưu, hoặc <b>Huỷ sửa</b>.
        </div>

       
      </div>

      <div class="card">
        <div class="table-wrap">
          <table style="min-width: 980px;">
            <thead>
              <tr>
                <th>Ngày đặt</th>
                <th>Khách</th>
                <th>SĐT</th>
                <th>Nội dung đặt</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="orderTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===== Helpers =====
    const VND = new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" });
    const NF  = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 2 });
    const fmtMoney = (n) => VND.format(Number.isFinite(n) ? n : 0);
    const fmtKg = (n) => `${NF.format(Number.isFinite(n) ? n : 0)} kg`;
    const fmtCon = (n) => `${Number.isFinite(n) ? n : 0} con`;

    const toKg = (v) => {
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const toNum = (v) => {
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const toInt = (v) => {
      const n = Math.floor(Number(v));
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));

    const scrollToEl = (el) => {
      try { el.scrollIntoView({ behavior: "smooth", block: "start" }); } catch {}
    };

    // ===== Vietnamese Lunar Calendar (solar -> lunar) =====
    // Dựa theo thuật toán phổ biến (độ chính xác thực tế tốt), timezone VN = 7
    const PI = Math.PI;

    function INT(d){ return Math.floor(d); }

    function jdFromDate(dd, mm, yy) {
      const a = INT((14 - mm) / 12);
      const y = yy + 4800 - a;
      const m = mm + 12 * a - 3;
      let jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - INT(y / 100) + INT(y / 400) - 32045;
      if (jd < 2299161) {
        jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - 32083;
      }
      return jd;
    }

    function NewMoon(k) {
      const T = k / 1236.85;
      const T2 = T * T;
      const T3 = T2 * T;
      const dr = PI / 180;
      let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
      Jd1 += 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
      const M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
      const Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
      const F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
      let C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
      C1 -= 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
      C1 -= 0.0004 * Math.sin(dr * 3 * Mpr);
      C1 += 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
      C1 -= 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
      C1 -= 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
      C1 += 0.0010 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));
      let deltat;
      if (T < -11) {
        deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
      } else {
        deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
      }
      return Jd1 + C1 - deltat;
    }

    function SunLongitude(jdn) {
      const T = (jdn - 2451545.0) / 36525;
      const T2 = T * T;
      const dr = PI / 180;
      const M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
      const L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;
      let DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
      DL += (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
      let L = L0 + DL;
      L = L * dr;
      L = L - PI * 2 * INT(L / (PI * 2));
      return L;
    }

    function getSunLongitude(dayNumber, timeZone) {
      return INT(SunLongitude(dayNumber - 0.5 - timeZone / 24) / PI * 6);
    }

    function getNewMoonDay(k, timeZone) {
      return INT(NewMoon(k) + 0.5 + timeZone / 24);
    }

    function getLunarMonth11(yy, timeZone) {
      const off = jdFromDate(31, 12, yy) - 2415021;
      const k = INT(off / 29.530588853);
      let nm = getNewMoonDay(k, timeZone);
      const sunLong = getSunLongitude(nm, timeZone);
      if (sunLong >= 9) {
        nm = getNewMoonDay(k - 1, timeZone);
      }
      return nm;
    }

    function getLeapMonthOffset(a11, timeZone) {
      const k = INT(0.5 + (a11 - 2415021.076998695) / 29.530588853);
      let last = 0;
      let i = 1;
      let arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
      do {
        last = arc;
        i++;
        arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
      } while (arc !== last && i < 14);
      return i - 1;
    }

    function convertSolar2Lunar(dd, mm, yy, timeZone) {
      const dayNumber = jdFromDate(dd, mm, yy);
      const k = INT((dayNumber - 2415021.076998695) / 29.530588853);
      let monthStart = getNewMoonDay(k + 1, timeZone);
      if (monthStart > dayNumber) monthStart = getNewMoonDay(k, timeZone);

      let a11 = getLunarMonth11(yy, timeZone);
      let b11 = a11;
      let lunarYear;

      if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1, timeZone);
      } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1, timeZone);
      }

      const lunarDay = dayNumber - monthStart + 1;
      const diff = INT((monthStart - a11) / 29);
      let lunarMonth = diff + 11;
      let lunarLeap = 0;

      if (b11 - a11 > 365) {
        const leapMonthDiff = getLeapMonthOffset(a11, timeZone);
        if (diff >= leapMonthDiff) {
          lunarMonth = diff + 10;
          if (diff === leapMonthDiff) lunarLeap = 1;
        }
      }

      if (lunarMonth > 12) lunarMonth -= 12;
      if (lunarMonth >= 11 && diff < 4) lunarYear -= 1;

      return [lunarDay, lunarMonth, lunarYear, lunarLeap];
    }

    function fmtLunarFromISODate(isoDateStr){
      if(!isoDateStr) return "";
      const [y, m, d] = isoDateStr.split("-").map(Number);
      if(!y || !m || !d) return "";
      const [ld, lm, ly, leap] = convertSolar2Lunar(d, m, y, 7);
      const dd = String(ld).padStart(2,"0");
      const mm = String(lm).padStart(2,"0");
      return `${dd}/${mm}/${ly}${leap ? " (Nhuận)" : ""}`;
    }

    // ===== State =====
    const LS_REVENUE = "ga_doanh_thu_con_kg_v3_lunar";
    const LS_ORDERS  = "ga_orders_v2";
    let rows = [];
    let orders = [];
    let editingRevenueIndex = null;
    let editingOrderIndex = null;

    // ===== DOM (Doanh thu) =====
    const $revenueCard = document.getElementById("revenueCard");
    const $date = document.getElementById("date");
    const $customerName = document.getElementById("customerName");
    const $lunarDate = document.getElementById("lunarDate");

    const $roosterCount = document.getElementById("roosterCount");
    const $roosterKg = document.getElementById("roosterKg");
    const $roosterPrice = document.getElementById("roosterPrice");

    const $henCount = document.getElementById("henCount");
    const $henKg = document.getElementById("henKg");
    const $henPrice = document.getElementById("henPrice");

    const $totalCount = document.getElementById("totalCount");
    const $totalKg = document.getElementById("totalKg");
    const $amount = document.getElementById("amount");
    const $tbody = document.getElementById("tbody");

    const $grandTotal = document.getElementById("grandTotal");
    const $grandCount = document.getElementById("grandCount");
    const $grandKg = document.getElementById("grandKg");
    const $grandRoosterCount = document.getElementById("grandRoosterCount");
    const $grandRoosterKg = document.getElementById("grandRoosterKg");
    const $grandHenCount = document.getElementById("grandHenCount");
    const $grandHenKg = document.getElementById("grandHenKg");

    const $addBtn = document.getElementById("addBtn");
    const $cancelEditBtn = document.getElementById("cancelEditBtn");
    const $editHint = document.getElementById("editHint");

    const $clearBtn = document.getElementById("clearBtn");
    const $exportBtn = document.getElementById("exportBtn");

    // ===== DOM (Orders) =====
    const $orderCard = document.getElementById("orderCard");
    const $orderDate = document.getElementById("orderDate");
    const $customer = document.getElementById("customer");
    const $phone = document.getElementById("phone");
    const $status = document.getElementById("status");
    const $orderContent = document.getElementById("orderContent");
    const $orderNote = document.getElementById("orderNote");
    const $orderCount = document.getElementById("orderCount");
    const $orderTbody = document.getElementById("orderTbody");

    const $addOrderBtn = document.getElementById("addOrderBtn");
    const $cancelOrderEditBtn = document.getElementById("cancelOrderEditBtn");
    const $orderEditHint = document.getElementById("orderEditHint");

    const $clearOrderBtn = document.getElementById("clearOrderBtn");
    const $exportOrderBtn = document.getElementById("exportOrderBtn");

    // ===== Init date inputs =====
    (function initDates(){
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      $date.value = `${yyyy}-${mm}-${dd}`;

      const hh = String(today.getHours()).padStart(2,"0");
      const mi = String(today.getMinutes()).padStart(2,"0");
      $orderDate.value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    })();

    // ===== Auto fill lunar date when date changes (but don't overwrite if user edited manually) =====
    let lastAutoLunar = "";
    function syncLunarFromDate(){
      const auto = fmtLunarFromISODate($date.value);
      if(!$lunarDate.value || $lunarDate.value === lastAutoLunar){
        $lunarDate.value = auto;
      }
      lastAutoLunar = auto;
    }
    $date.addEventListener("change", syncLunarFromDate);
    syncLunarFromDate();

    // ===== Live calc =====
    function calcPreview(){
      const rC = toInt($roosterCount.value);
      const hC = toInt($henCount.value);

      const rKg = toKg($roosterKg.value);
      const hKg = toKg($henKg.value);

      const rP = toNum($roosterPrice.value);
      const hP = toNum($henPrice.value);

      const totalCount = rC + hC;
      const totalKg = rKg + hKg;
      const amount = (rKg * rP) + (hKg * hP);

      $totalCount.value = fmtCon(totalCount);
      $totalKg.value = fmtKg(totalKg);
      $amount.value = fmtMoney(amount);
    }
    [$roosterCount,$henCount,$roosterKg,$henKg,$roosterPrice,$henPrice].forEach(el => el.addEventListener("input", calcPreview));
    calcPreview();

    // ===== Persistence =====
    function saveRevenue(){ localStorage.setItem(LS_REVENUE, JSON.stringify(rows)); }
    function loadRevenue(){
      try{
        const raw = localStorage.getItem(LS_REVENUE);
        rows = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(rows)) rows = [];
      }catch{ rows = []; }

      rows = rows.map(r => ({
        date: r?.date ?? "",
        lunarDate: r?.lunarDate ?? "",
        customerName: r?.customerName ?? "",

        roosterCount: toInt(r?.roosterCount),
        roosterKg: toKg(r?.roosterKg),
        roosterPrice: toNum(r?.roosterPrice),

        henCount: toInt(r?.henCount),
        henKg: toKg(r?.henKg),
        henPrice: toNum(r?.henPrice),
      }));
    }

    function saveOrders(){ localStorage.setItem(LS_ORDERS, JSON.stringify(orders)); }
    function loadOrders(){
      try{
        const raw = localStorage.getItem(LS_ORDERS);
        orders = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(orders)) orders = [];
      }catch{ orders = []; }
    }

    // ===== Form reset / edit state =====
    function setRevenueEditing(on){
      $cancelEditBtn.style.display = on ? "" : "none";
      $editHint.style.display = on ? "" : "none";
      $addBtn.textContent = on ? "Cập nhật" : "+ Thêm dòng";
    }
    function resetRevenueForm(keepDate=true){
      if(!keepDate){
        // $date.value = "";
      }
      $customerName.value = "";
      // lịch âm sẽ sync theo ngày dương (nếu user muốn giữ thì cứ giữ)
      syncLunarFromDate();

      $roosterCount.value = 0;
      $henCount.value = 0;
      $roosterKg.value = 0;
      $henKg.value = 0;
      $roosterPrice.value = "";
      $henPrice.value = "";
      calcPreview();
    }

    function setOrderEditing(on){
      $cancelOrderEditBtn.style.display = on ? "" : "none";
      $orderEditHint.style.display = on ? "" : "none";
      $addOrderBtn.textContent = on ? "Cập nhật" : "+ Thêm note";
    }
    function resetOrderForm(keepDate=true){
      if(!keepDate){
        // $orderDate.value = "";
      }
      $customer.value = "";
      $phone.value = "";
      $status.value = "Mới";
      $orderContent.value = "";
      $orderNote.value = "";
    }

    // ===== Validate revenue input =====
    function getRevenueFormDataOrAlert(){
      const date = $date.value;
      const customerName = $customerName.value.trim();
      const lunarDate = $lunarDate.value.trim();

      const roosterCount = toInt($roosterCount.value);
      const henCount = toInt($henCount.value);

      const roosterKg = toKg($roosterKg.value);
      const henKg = toKg($henKg.value);

      const roosterPrice = toNum($roosterPrice.value);
      const henPrice = toNum($henPrice.value);

      if(!date){
        alert("Vui lòng chọn ngày (dương lịch).");
        return null;
      }

      // nếu lunar trống thì tự fill
      const lunarFinal = lunarDate || fmtLunarFromISODate(date);

      if(roosterKg + henKg <= 0){
        alert("Tổng kg phải > 0 (vì tính tiền theo kg).");
        return null;
      }
      if(roosterKg > 0 && roosterPrice <= 0){
        alert("Bạn nhập kg trống > 0 thì đơn giá trống phải > 0.");
        return null;
      }
      if(henKg > 0 && henPrice <= 0){
        alert("Bạn nhập kg mái > 0 thì đơn giá mái phải > 0.");
        return null;
      }

      return {
        date,
        lunarDate: lunarFinal,
        customerName,

        roosterCount, roosterKg, roosterPrice,
        henCount, henKg, henPrice
      };
    }

    // ===== Render Revenue =====
    function renderRevenue(){
      $tbody.innerHTML = "";

      let totalMoney = 0;
      let totalCount = 0;
      let totalKg = 0;

      let totalRC = 0, totalHC = 0;
      let totalRK = 0, totalHK = 0;

      rows.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const cSum = row.roosterCount + row.henCount;
        const kSum = row.roosterKg + row.henKg;
        const amount = (row.roosterKg * row.roosterPrice) + (row.henKg * row.henPrice);

        totalMoney += amount;
        totalCount += cSum;
        totalKg += kSum;

        totalRC += row.roosterCount;
        totalHC += row.henCount;
        totalRK += row.roosterKg;
        totalHK += row.henKg;

        tr.innerHTML = `
          <td>${esc(row.date)}</td>
          <td>${esc(row.lunarDate || "")}</td>
          <td>${esc(row.customerName || "")}</td>

          <td class="num">${row.roosterCount}</td>
          <td class="num">${NF.format(row.roosterKg)}</td>
          <td class="num">${fmtMoney(row.roosterPrice)}</td>

          <td class="num">${row.henCount}</td>
          <td class="num">${NF.format(row.henKg)}</td>
          <td class="num">${fmtMoney(row.henPrice)}</td>

          <td class="num"><b>${cSum}</b></td>
          <td class="num"><b>${NF.format(kSum)}</b></td>
          <td class="num"><b>${fmtMoney(amount)}</b></td>

          <td>
            <button class="btn-mini ok" data-edit="${idx}">Sửa</button>
            <button class="btn-mini danger" data-del="${idx}">Xoá</button>
          </td>
        `;
        $tbody.appendChild(tr);
      });

      $grandTotal.textContent = fmtMoney(totalMoney);
      $grandCount.textContent = totalCount;
      $grandKg.textContent = NF.format(totalKg);

      $grandRoosterCount.textContent = totalRC;
      $grandHenCount.textContent = totalHC;
      $grandRoosterKg.textContent = NF.format(totalRK);
      $grandHenKg.textContent = NF.format(totalHK);
    }

    // ===== Render Orders =====
    function renderOrders(){
      $orderTbody.innerHTML = "";
      $orderCount.textContent = orders.length;

      orders.forEach((o, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(o.orderDate || "")}</td>
          <td>${esc(o.customer || "")}</td>
          <td>${esc(o.phone || "")}</td>
          <td>${esc(o.content || "")}</td>
          <td>${esc(o.note || "")}</td>
          <td><b>${esc(o.status || "Mới")}</b></td>
          <td>
            <button class="btn-mini ok" data-oedit="${idx}">Sửa</button>
            <button class="btn-mini danger" data-odel="${idx}">Xoá</button>
          </td>
        `;
        $orderTbody.appendChild(tr);
      });
    }

    // ===== Revenue add/update/cancel =====
    $addBtn.addEventListener("click", () => {
      const data = getRevenueFormDataOrAlert();
      if(!data) return;

      if(editingRevenueIndex === null){
        rows.unshift(data);
      }else{
        rows[editingRevenueIndex] = data;
      }

      saveRevenue();
      renderRevenue();

      editingRevenueIndex = null;
      setRevenueEditing(false);
      resetRevenueForm(true);
      $customerName.focus();
    });

    $cancelEditBtn.addEventListener("click", () => {
      editingRevenueIndex = null;
      setRevenueEditing(false);
      resetRevenueForm(true);
    });

    // Revenue table actions
    $tbody.addEventListener("click", (e) => {
      const delBtn = e.target.closest("button[data-del]");
      const editBtn = e.target.closest("button[data-edit]");

      if(delBtn){
        const idx = Number(delBtn.getAttribute("data-del"));
        if(!Number.isFinite(idx)) return;

        if(editingRevenueIndex === idx){
          editingRevenueIndex = null;
          setRevenueEditing(false);
          resetRevenueForm(true);
        }

        rows.splice(idx, 1);
        saveRevenue();
        renderRevenue();
        return;
      }

      if(editBtn){
        const idx = Number(editBtn.getAttribute("data-edit"));
        if(!Number.isFinite(idx)) return;
        const r = rows[idx];
        if(!r) return;

        editingRevenueIndex = idx;
        setRevenueEditing(true);

        $date.value = r.date || "";
        // sync lunar from date first, then overwrite by saved lunar (nếu có)
        syncLunarFromDate();
        $lunarDate.value = r.lunarDate || $lunarDate.value;

        $customerName.value = r.customerName || "";

        $roosterCount.value = r.roosterCount ?? 0;
        $roosterKg.value = r.roosterKg ?? 0;
        $roosterPrice.value = r.roosterPrice ?? "";

        $henCount.value = r.henCount ?? 0;
        $henKg.value = r.henKg ?? 0;
        $henPrice.value = r.henPrice ?? "";

        calcPreview();

        scrollToEl($revenueCard);
        $customerName.focus();
      }
    });

    $clearBtn.addEventListener("click", () => {
      if(!rows.length) return;
      if(confirm("Xoá toàn bộ dữ liệu doanh thu?")) {
        rows = [];
        saveRevenue();
        renderRevenue();
        editingRevenueIndex = null;
        setRevenueEditing(false);
        resetRevenueForm(true);
      }
    });

    $exportBtn.addEventListener("click", () => {
      const header = [
        "Ngay_duong_lich","Lich_am","Ten_khach_hang",
        "Trong_con","Trong_kg","Gia_trong_vnd_kg",
        "Mai_con","Mai_kg","Gia_mai_vnd_kg",
        "Tong_con","Tong_kg","Thanh_tien"
      ];
      const lines = [header.join(",")];

      rows.slice().reverse().forEach(r => {
        const cSum = r.roosterCount + r.henCount;
        const kSum = r.roosterKg + r.henKg;
        const amount = (r.roosterKg * r.roosterPrice) + (r.henKg * r.henPrice);

        const safe = (s) => String(s ?? "").replaceAll(",", " ");

        lines.push([
          safe(r.date),
          safe(r.lunarDate),
          safe(r.customerName),

          r.roosterCount, r.roosterKg, r.roosterPrice,
          r.henCount, r.henKg, r.henPrice,
          cSum, kSum, amount
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "doanh_thu_ban_ga_con_kg_lich_am.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ===== Orders add/update/cancel =====
    function getOrderFormDataOrAlert(){
      const orderDate = $orderDate.value;
      const customer = $customer.value.trim();
      const phone = $phone.value.trim();
      const status = $status.value;
      const content = $orderContent.value.trim();
      const note = $orderNote.value.trim();

      if(!orderDate){
        alert("Vui lòng chọn ngày đặt.");
        return null;
      }
      if(!customer && !phone){
        alert("Nhập ít nhất Tên khách hoặc SĐT.");
        return null;
      }
      if(!content){
        alert("Vui lòng nhập Nội dung đặt.");
        return null;
      }
      return { orderDate, customer, phone, status, content, note };
    }

    $addOrderBtn.addEventListener("click", () => {
      const data = getOrderFormDataOrAlert();
      if(!data) return;

      if(editingOrderIndex === null){
        orders.unshift(data);
      }else{
        orders[editingOrderIndex] = data;
      }

      saveOrders();
      renderOrders();

      editingOrderIndex = null;
      setOrderEditing(false);
      resetOrderForm(true);
      $customer.focus();
    });

    $cancelOrderEditBtn.addEventListener("click", () => {
      editingOrderIndex = null;
      setOrderEditing(false);
      resetOrderForm(true);
    });

    $orderTbody.addEventListener("click", (e) => {
      const delBtn = e.target.closest("button[data-odel]");
      const editBtn = e.target.closest("button[data-oedit]");

      if(delBtn){
        const idx = Number(delBtn.getAttribute("data-odel"));
        if(!Number.isFinite(idx)) return;

        if(editingOrderIndex === idx){
          editingOrderIndex = null;
          setOrderEditing(false);
          resetOrderForm(true);
        }

        orders.splice(idx, 1);
        saveOrders();
        renderOrders();
        return;
      }

      if(editBtn){
        const idx = Number(editBtn.getAttribute("data-oedit"));
        if(!Number.isFinite(idx)) return;
        const o = orders[idx];
        if(!o) return;

        editingOrderIndex = idx;
        setOrderEditing(true);

        $orderDate.value = o.orderDate || "";
        $customer.value = o.customer || "";
        $phone.value = o.phone || "";
        $status.value = o.status || "Mới";
        $orderContent.value = o.content || "";
        $orderNote.value = o.note || "";

        scrollToEl($orderCard);
        $customer.focus();
      }
    });

    $clearOrderBtn.addEventListener("click", () => {
      if(!orders.length) return;
      if(confirm("Xoá toàn bộ note đặt hàng?")) {
        orders = [];
        saveOrders();
        renderOrders();
        editingOrderIndex = null;
        setOrderEditing(false);
        resetOrderForm(true);
      }
    });

    $exportOrderBtn.addEventListener("click", () => {
      const header = ["Ngay_dat","Khach","SDT","Noi_dung","Ghi_chu","Trang_thai"];
      const lines = [header.join(",")];

      orders.slice().reverse().forEach(o => {
        const row = [
          (o.orderDate || "").replaceAll(",", " "),
          (o.customer || "").replaceAll(",", " "),
          (o.phone || "").replaceAll(",", " "),
          (o.content || "").replaceAll(",", " "),
          (o.note || "").replaceAll(",", " "),
          (o.status || "").replaceAll(",", " ")
        ];
        lines.push(row.join(","));
      });

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "note_dat_hang_ban_ga.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // ===== Start =====
    loadRevenue();
    loadOrders();
    renderRevenue();
    renderOrders();
    calcPreview();
    // nếu form lunar đang trống, tự sync luôn
    syncLunarFromDate();
  </script>
</body>
</html>
