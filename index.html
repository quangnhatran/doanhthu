<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Doanh Thu Bán Gà</title>
  <style>
    :root{
      --bg:#0b1220; --muted:#94a3b8; --text:#e2e8f0;
      --danger:#fb7185; --ok:#34d399;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, #1b2a55 0%, transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, #123a52 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      padding-top: env(safe-area-inset-top);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
    }
    .wrap{max-width:1180px; margin:28px auto; padding:0 16px;}
    h1{margin:0 0 14px; font-size:22px; letter-spacing:.2px}
    .grid{display:grid; gap:14px; grid-template-columns: 1fr;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .muted{color:var(--muted)}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}

    .row{
      display:grid; gap:10px;
      grid-template-columns: repeat(15, 1fr);
      align-items:end
    }
    .order-grid{display:grid; gap:10px; grid-template-columns: repeat(5, 1fr); align-items:end}
    .damage-row{
      display:grid; gap:10px;
      grid-template-columns: repeat(12, 1fr);
      align-items:end
    }

    input, select, textarea{
      width:100%; padding:10px 10px;
      border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-family: inherit;
      font-size:16px; /* tránh iOS auto-zoom */
    }
    textarea{min-height:40px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(56,189,248,.7);
      box-shadow:0 0 0 3px rgba(56,189,248,.15)
    }

    .btns{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap}
    button{
      border:none; cursor:pointer; border-radius:10px;
      padding:10px 12px; font-weight:600;
      background: rgba(56,189,248,.14); color: #cbefff;
      border:1px solid rgba(56,189,248,.25);
    }
    button:hover{filter:brightness(1.08)}
    .danger{background: rgba(251,113,133,.14); border-color: rgba(251,113,133,.25); color:#ffd1d9}
    .ok{background: rgba(52,211,153,.14); border-color: rgba(52,211,153,.25); color:#d7ffee}
    .ghost{background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color:#e2e8f0}
    .btn-mini{
      padding:7px 10px;
      font-size:13px;
      border-radius:9px;
      display:inline-flex;
      gap:6px;
      align-items:center;
      margin-right:8px;
      white-space:nowrap;
    }

    .table-wrap{overflow:auto; border-radius:12px; border:1px solid rgba(255,255,255,.10)}
    table{width:100%; border-collapse:collapse; background: rgba(0,0,0,.18)}
    .t-revenue{min-width:1960px;}
    .t-orders{min-width:1180px;}
    .t-damage{min-width:1500px;}

    thead th{
      text-align:left; font-size:12px; color:var(--muted);
      padding:12px; background: rgba(255,255,255,.04);
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      backdrop-filter: blur(6px);
    }
    tbody td{
      padding:12px; border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:middle;
    }
    tbody tr:hover{background: rgba(255,255,255,.03)}
    .num{text-align:right; font-variant-numeric: tabular-nums;}

    .totalbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:12px; border:1px dashed rgba(255,255,255,.18);
      border-radius:12px; background: rgba(0,0,0,.18);
      flex-wrap:wrap;
    }
    .totalbar .big{font-size:18px; font-weight:800}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color:var(--muted); font-size:12px;
    }
    .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.45}
    .section-title{display:flex; align-items:baseline; justify-content:space-between; gap:10px; margin:0 0 10px}
    .section-title h2{margin:0; font-size:16px}
    .section-title .muted{font-size:12px}

    @media (max-width: 900px){
      .row, .order-grid, .damage-row{grid-template-columns: 1fr;}
      .btns{justify-content:stretch}
      button{flex:1}
    }

    /* iPhone X */
    @media only screen
      and (device-width: 375px)
      and (device-height: 812px)
      and (-webkit-device-pixel-ratio: 3) {

      .wrap{ margin: 14px auto; padding: 0 12px; }
      h1{font-size: 18px; margin-bottom: 12px;}
      .card{padding: 12px; border-radius: 12px;}

      .row, .order-grid, .damage-row{
        grid-template-columns: 1fr;
        gap: 10px;
        align-items: stretch;
      }

      .btns{width:100%; justify-content:stretch; gap:10px}
      button{
        width:100%;
        padding: 12px 12px;
        font-size: 15px;
        border-radius: 12px;
      }

      .totalbar{
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .totalbar .big{font-size: 18px;}
      .pill{width:100%; justify-content: space-between; padding: 8px 10px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Doanh Thu Bán Gà</h1>

    <div class="grid">
      <!-- ======================= DOANH THU ======================= -->
      <div class="card" id="revenueCard">
        <div class="row">
          <div>
            <label for="revDate">Ngày (Dương lịch)</label>
            <input id="revDate" type="date" />
          </div>

          <div>
            <label for="revCustomerName">Tên khách hàng</label>
            <input id="revCustomerName" type="text" placeholder="Ví dụ: Anh Nam" />
          </div>

          <div>
            <label for="revLunarDate">Lịch âm (VN)</label>
            <input id="revLunarDate" type="text" placeholder="VD: 15/01/2026" />
          </div>

          <div>
            <label for="revRoosterCount">Gà trống (con)</label>
            <input id="revRoosterCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="revRoosterKg">Gà trống (kg)</label>
            <input id="revRoosterKg" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="revRoosterPrice">Đơn giá trống (VND/kg)</label>
            <input id="revRoosterPrice" type="number" min="0" step="1000" placeholder="VD: 120000" />
          </div>

          <div>
            <label for="revHenCount">Gà mái (con)</label>
            <input id="revHenCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="revHenKg">Gà mái (kg)</label>
            <input id="revHenKg" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="revHenPrice">Đơn giá mái (VND/kg)</label>
            <input id="revHenPrice" type="number" min="0" step="1000" placeholder="VD: 110000" />
          </div>

          <div>
            <label for="revLabor">Tiền công làm</label>
            <input id="revLabor" type="number" min="0" step="1000" placeholder="VD: 20000" />
          </div>

          <div>
            <label for="revReceived">Tiền nhận được</label>
            <input id="revReceived" type="number" min="0" step="1000" placeholder="Bỏ trống = Tổng cộng" />
          </div>

          <div>
            <label>Tổng số gà</label>
            <input id="revTotalCount" type="text" disabled value="0 con" />
          </div>

          <div>
            <label>Tổng kg</label>
            <input id="revTotalKg" type="text" disabled value="0 kg" />
          </div>

          <div>
            <label>Tiền gà</label>
            <input id="revChickenMoney" type="text" disabled value="0 ₫" />
          </div>

          <div>
            <label>Tổng cộng (gà + công)</label>
            <input id="revTotalAll" type="text" disabled value="0 ₫" />
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap">
          <div class="pill">
           
          </div>
          <div class="btns">
            <button class="ok" id="revAddBtn">+ Thêm dòng</button>
            <button class="ghost" id="revCancelEditBtn" style="display:none">Huỷ sửa</button>
            <button id="revExportBtn">Xuất CSV</button>
            <button class="danger" id="revClearBtn">Xoá tất cả</button>
          </div>
        </div>

        <div class="hint" id="revEditHint" style="display:none">
          Bạn đang <b>sửa</b> một dòng. Nhấn <b>Cập nhật</b> để lưu, hoặc <b>Huỷ sửa</b>.
        </div>

       
      </div>

      <div class="card">
        <div class="totalbar">
          <div>
            <div class="muted">Tổng doanh thu (theo Tiền nhận)</div>
            <div class="big" id="revGrandReceived">0 ₫</div>
          </div>
          <div class="pill">
            Tổng tiền gà: <b id="revGrandChicken">0 ₫</b> · Tổng công: <b id="revGrandLabor">0 ₫</b> · Tổng cộng: <b id="revGrandAll">0 ₫</b>
          </div>
          <div class="pill">
            Tổng:
            <b id="revGrandCount">0</b> con · <b id="revGrandKg">0</b> kg
            (Trống <b id="revGrandRoosterCount">0</b> con/<b id="revGrandRoosterKg">0</b> kg ·
             Mái <b id="revGrandHenCount">0</b> con/<b id="revGrandHenKg">0</b> kg)
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="table-wrap">
          <table class="t-revenue">
            <thead>
              <tr>
                <th>Ngày (DL)</th>
                <th>Lịch âm</th>
                <th>Khách hàng</th>

                <th class="num">Trống (con)</th>
                <th class="num">Trống (kg)</th>
                <th class="num">Giá trống</th>

                <th class="num">Mái (con)</th>
                <th class="num">Mái (kg)</th>
                <th class="num">Giá mái</th>

                <th class="num">Tổng con</th>
                <th class="num">Tổng kg</th>

                <th class="num">Tiền gà</th>
                <th class="num">Tiền công</th>
                <th class="num">Tổng cộng</th>
                <th class="num">Tiền nhận</th>

                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="revTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ======================= NOTE ĐẶT HÀNG ======================= -->
      <div class="card" id="orderCard">
        <div class="section-title">
          <h2>Note đặt hàng</h2>
          <div class="muted">Có lịch âm, sửa/xoá</div>
        </div>

        <div class="order-grid">
          <div>
            <label for="orderDate">Ngày đặt</label>
            <input id="orderDate" type="datetime-local"/>
          </div>
          <div>
            <label for="orderLunarDate">Lịch âm (VN)</label>
            <input id="orderLunarDate" type="text" placeholder="Tự điền theo ngày đặt" />
          </div>
          <div>
            <label for="customer">Tên khách</label>
            <input id="customer" type="text" placeholder="Ví dụ: Anh Nam"/>
          </div>
          <div>
            <label for="phone">SĐT</label>
            <input id="phone" type="tel" placeholder="Ví dụ: 09xxxxxxxx"/>
          </div>
          <div>
            <label for="status">Trạng thái</label>
            <select id="status">
              <option value="Mới">Mới</option>
              <option value="Đang xử lý">Đang xử lý</option>
              <option value="Đã giao">Đã giao</option>
              <option value="Huỷ">Huỷ</option>
            </select>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="orderContent">Nội dung đặt</label>
            <textarea id="orderContent" placeholder="Ví dụ: Trống 2 con (3.2kg), Mái 1 con (1.6kg), giao 18:30"></textarea>
          </div>

          <div style="grid-column: 1 / -1;">
            <label for="orderNote">Ghi chú</label>
            <textarea id="orderNote" placeholder="Ví dụ: Khách trả tiền mặt, gọi trước 10 phút"></textarea>
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap">
          <div class="pill">Tổng đơn: <b id="orderCount">0</b></div>
          <div class="btns">
            <button class="ok" id="addOrderBtn">+ Thêm note</button>
            <button class="ghost" id="cancelOrderEditBtn" style="display:none">Huỷ sửa</button>
            <button id="exportOrderBtn">Xuất CSV</button>
            <button class="danger" id="clearOrderBtn">Xoá tất cả</button>
          </div>
        </div>

        <div class="hint" id="orderEditHint" style="display:none">
          Bạn đang <b>sửa</b> một note. Nhấn <b>Cập nhật</b> để lưu, hoặc <b>Huỷ sửa</b>.
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="t-orders">
            <thead>
              <tr>
                <th>Ngày đặt</th>
                <th>Lịch âm</th>
                <th>Khách</th>
                <th>SĐT</th>
                <th>Nội dung đặt</th>
                <th>Ghi chú</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="orderTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- ======================= THIỆT HẠI ======================= -->
      <div class="card" id="damageCard">
        <div class="section-title">
          <h2>Bảng thiệt hại</h2>
          
        </div>

        <div class="damage-row">
          <div>
            <label for="damDate">Ngày</label>
            <input id="damDate" type="date" />
          </div>

          <div>
            <label for="damRoosterCount">Gà trống (con)</label>
            <input id="damRoosterCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="damRoosterKg">Trống (kg)</label>
            <input id="damRoosterKg" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="damRoosterPrice">Đơn giá trống (VND/kg) (có thể bỏ)</label>
            <input id="damRoosterPrice" type="number" min="0" step="1000" placeholder="Bỏ trống = 0" />
          </div>

          <div>
            <label for="damHenCount">Gà mái (con)</label>
            <input id="damHenCount" type="number" min="0" step="1" value="0" />
          </div>
          <div>
            <label for="damHenKg">Mái (kg)</label>
            <input id="damHenKg" type="number" min="0" step="0.1" value="0" />
          </div>
          <div>
            <label for="damHenPrice">Đơn giá mái (VND/kg) (có thể bỏ)</label>
            <input id="damHenPrice" type="number" min="0" step="1000" placeholder="Bỏ trống = 0" />
          </div>

          <div>
            <label>Tổng số lượng</label>
            <input id="damTotalCount" type="text" disabled value="0 con" />
          </div>
          <div>
            <label>Tổng kg</label>
            <input id="damTotalKg" type="text" disabled value="0 kg" />
          </div>
          <div>
            <label>Tổng tiền</label>
            <input id="damAmount" type="text" disabled value="0 ₫" />
          </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; margin-top:12px; flex-wrap:wrap">
          <div class="pill">Tổng tiền: <b>(kg × đơn giá)</b> — đơn giá bỏ trống thì = 0</div>
          <div class="btns">
            <button class="ok" id="damAddBtn">+ Thêm dòng</button>
            <button class="ghost" id="damCancelEditBtn" style="display:none">Huỷ sửa</button>
            <button id="damExportBtn">Xuất CSV</button>
            <button class="danger" id="damClearBtn">Xoá tất cả</button>
          </div>
        </div>

        <div class="hint" id="damEditHint" style="display:none">
          Bạn đang <b>sửa</b> một dòng thiệt hại. Nhấn <b>Cập nhật</b> để lưu, hoặc <b>Huỷ sửa</b>.
        </div>
      </div>

      <div class="card">
        <div class="totalbar">
          <div>
            <div class="muted">Tổng thiệt hại</div>
            <div class="big" id="damGrandTotal">0 ₫</div>
          </div>
          <div class="pill">
            Tổng kg: <b id="damGrandKg">0</b>
            (Trống <b id="damGrandRoosterKg">0</b> · Mái <b id="damGrandHenKg">0</b>)
          </div>
          <div class="pill">
            Tổng số lượng gà: <b id="damGrandCount">0</b>
            (Trống <b id="damGrandRoosterCount">0</b> · Mái <b id="damGrandHenCount">0</b>)
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="table-wrap">
          <table class="t-damage">
            <thead>
              <tr>
                <th>Ngày</th>

                <th class="num">Trống (con)</th>
                <th class="num">Trống (kg)</th>
                <th class="num">Giá trống</th>

                <th class="num">Mái (con)</th>
                <th class="num">Mái (kg)</th>
                <th class="num">Giá mái</th>

                <th class="num">Tổng con</th>
                <th class="num">Tổng kg</th>
                <th class="num">Tổng tiền</th>

                <th>Thao tác</th>
              </tr>
            </thead>
            <tbody id="damTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =================== Helpers ===================
    const VND = new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" });
    const NF  = new Intl.NumberFormat("vi-VN", { maximumFractionDigits: 2 });
    const fmtMoney = (n) => VND.format(Number.isFinite(n) ? n : 0);
    const fmtKg = (n) => `${NF.format(Number.isFinite(n) ? n : 0)} kg`;
    const fmtCon = (n) => `${Number.isFinite(n) ? n : 0} con`;

    const toKg = (v) => {
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const toNum = (v) => {
      if (v === "" || v === null || v === undefined) return 0;
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const toInt = (v) => {
      const n = Math.floor(Number(v));
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const esc = (s) => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
    const scrollToEl = (el) => { try { el.scrollIntoView({ behavior:"smooth", block:"start" }); } catch {} };

    // =================== Vietnamese Lunar Calendar (solar -> lunar) ===================
    const PI = Math.PI;
    function INT(d){ return Math.floor(d); }
    function jdFromDate(dd, mm, yy) {
      const a = INT((14 - mm) / 12);
      const y = yy + 4800 - a;
      const m = mm + 12 * a - 3;
      let jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - INT(y / 100) + INT(y / 400) - 32045;
      if (jd < 2299161) jd = dd + INT((153 * m + 2) / 5) + 365 * y + INT(y / 4) - 32083;
      return jd;
    }
    function NewMoon(k) {
      const T = k / 1236.85;
      const T2 = T * T;
      const T3 = T2 * T;
      const dr = PI / 180;
      let Jd1 = 2415020.75933 + 29.53058868 * k + 0.0001178 * T2 - 0.000000155 * T3;
      Jd1 += 0.00033 * Math.sin((166.56 + 132.87 * T - 0.009173 * T2) * dr);
      const M = 359.2242 + 29.10535608 * k - 0.0000333 * T2 - 0.00000347 * T3;
      const Mpr = 306.0253 + 385.81691806 * k + 0.0107306 * T2 + 0.00001236 * T3;
      const F = 21.2964 + 390.67050646 * k - 0.0016528 * T2 - 0.00000239 * T3;
      let C1 = (0.1734 - 0.000393 * T) * Math.sin(M * dr) + 0.0021 * Math.sin(2 * dr * M);
      C1 -= 0.4068 * Math.sin(Mpr * dr) + 0.0161 * Math.sin(dr * 2 * Mpr);
      C1 -= 0.0004 * Math.sin(dr * 3 * Mpr);
      C1 += 0.0104 * Math.sin(dr * 2 * F) - 0.0051 * Math.sin(dr * (M + Mpr));
      C1 -= 0.0074 * Math.sin(dr * (M - Mpr)) + 0.0004 * Math.sin(dr * (2 * F + M));
      C1 -= 0.0004 * Math.sin(dr * (2 * F - M)) - 0.0006 * Math.sin(dr * (2 * F + Mpr));
      C1 += 0.0010 * Math.sin(dr * (2 * F - Mpr)) + 0.0005 * Math.sin(dr * (2 * Mpr + M));
      let deltat;
      if (T < -11) deltat = 0.001 + 0.000839 * T + 0.0002261 * T2 - 0.00000845 * T3 - 0.000000081 * T * T3;
      else deltat = -0.000278 + 0.000265 * T + 0.000262 * T2;
      return Jd1 + C1 - deltat;
    }
    function SunLongitude(jdn) {
      const T = (jdn - 2451545.0) / 36525;
      const T2 = T * T;
      const dr = PI / 180;
      const M = 357.52910 + 35999.05030 * T - 0.0001559 * T2 - 0.00000048 * T * T2;
      const L0 = 280.46645 + 36000.76983 * T + 0.0003032 * T2;
      let DL = (1.914600 - 0.004817 * T - 0.000014 * T2) * Math.sin(dr * M);
      DL += (0.019993 - 0.000101 * T) * Math.sin(dr * 2 * M) + 0.000290 * Math.sin(dr * 3 * M);
      let L = L0 + DL;
      L = L * dr;
      L = L - PI * 2 * INT(L / (PI * 2));
      return L;
    }
    function getSunLongitude(dayNumber, timeZone) {
      return INT(SunLongitude(dayNumber - 0.5 - timeZone / 24) / PI * 6);
    }
    function getNewMoonDay(k, timeZone) {
      return INT(NewMoon(k) + 0.5 + timeZone / 24);
    }
    function getLunarMonth11(yy, timeZone) {
      const off = jdFromDate(31, 12, yy) - 2415021;
      const k = INT(off / 29.530588853);
      let nm = getNewMoonDay(k, timeZone);
      const sunLong = getSunLongitude(nm, timeZone);
      if (sunLong >= 9) nm = getNewMoonDay(k - 1, timeZone);
      return nm;
    }
    function getLeapMonthOffset(a11, timeZone) {
      const k = INT(0.5 + (a11 - 2415021.076998695) / 29.530588853);
      let last = 0, i = 1;
      let arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
      do {
        last = arc;
        i++;
        arc = getSunLongitude(getNewMoonDay(k + i, timeZone), timeZone);
      } while (arc !== last && i < 14);
      return i - 1;
    }
    function convertSolar2Lunar(dd, mm, yy, timeZone) {
      const dayNumber = jdFromDate(dd, mm, yy);
      const k = INT((dayNumber - 2415021.076998695) / 29.530588853);
      let monthStart = getNewMoonDay(k + 1, timeZone);
      if (monthStart > dayNumber) monthStart = getNewMoonDay(k, timeZone);

      let a11 = getLunarMonth11(yy, timeZone);
      let b11 = a11;
      let lunarYear;

      if (a11 >= monthStart) {
        lunarYear = yy;
        a11 = getLunarMonth11(yy - 1, timeZone);
      } else {
        lunarYear = yy + 1;
        b11 = getLunarMonth11(yy + 1, timeZone);
      }

      const lunarDay = dayNumber - monthStart + 1;
      const diff = INT((monthStart - a11) / 29);
      let lunarMonth = diff + 11;
      let lunarLeap = 0;

      if (b11 - a11 > 365) {
        const leapMonthDiff = getLeapMonthOffset(a11, timeZone);
        if (diff >= leapMonthDiff) {
          lunarMonth = diff + 10;
          if (diff === leapMonthDiff) lunarLeap = 1;
        }
      }

      if (lunarMonth > 12) lunarMonth -= 12;
      if (lunarMonth >= 11 && diff < 4) lunarYear -= 1;

      return [lunarDay, lunarMonth, lunarYear, lunarLeap];
    }
    function fmtLunarFromISODate(isoDateStr){
      if(!isoDateStr) return "";
      const [y, m, d] = isoDateStr.split("-").map(Number);
      if(!y || !m || !d) return "";
      const [ld, lm, ly, leap] = convertSolar2Lunar(d, m, y, 7);
      const dd = String(ld).padStart(2,"0");
      const mm = String(lm).padStart(2,"0");
      return `${dd}/${mm}/${ly}${leap ? " (Nhuận)" : ""}`;
    }
    function fmtLunarFromDateTimeLocal(dtLocal){
      if(!dtLocal) return "";
      const isoDate = dtLocal.split("T")[0];
      return fmtLunarFromISODate(isoDate);
    }

    // =================== LocalStorage keys ===================
    const LS_REVENUE = "ga_revenue_v4_received_labor"; // giữ key cũ để không mất dữ liệu
    const LS_ORDERS  = "ga_orders_v3_lunar";
    const LS_DAMAGE  = "ga_damage_v1";

    // =================== Revenue DOM ===================
    const $revenueCard = document.getElementById("revenueCard");
    const $revDate = document.getElementById("revDate");
    const $revCustomerName = document.getElementById("revCustomerName");
    const $revLunarDate = document.getElementById("revLunarDate");

    const $revRoosterCount = document.getElementById("revRoosterCount");
    const $revRoosterKg = document.getElementById("revRoosterKg");
    const $revRoosterPrice = document.getElementById("revRoosterPrice");

    const $revHenCount = document.getElementById("revHenCount");
    const $revHenKg = document.getElementById("revHenKg");
    const $revHenPrice = document.getElementById("revHenPrice");

    const $revLabor = document.getElementById("revLabor");
    const $revReceived = document.getElementById("revReceived");

    const $revTotalCount = document.getElementById("revTotalCount");
    const $revTotalKg = document.getElementById("revTotalKg");
    const $revChickenMoney = document.getElementById("revChickenMoney");
    const $revTotalAll = document.getElementById("revTotalAll");

    const $revTbody = document.getElementById("revTbody");

    const $revGrandReceived = document.getElementById("revGrandReceived");
    const $revGrandChicken = document.getElementById("revGrandChicken");
    const $revGrandLabor = document.getElementById("revGrandLabor");
    const $revGrandAll = document.getElementById("revGrandAll");

    const $revGrandCount = document.getElementById("revGrandCount");
    const $revGrandKg = document.getElementById("revGrandKg");
    const $revGrandRoosterCount = document.getElementById("revGrandRoosterCount");
    const $revGrandHenCount = document.getElementById("revGrandHenCount");
    const $revGrandRoosterKg = document.getElementById("revGrandRoosterKg");
    const $revGrandHenKg = document.getElementById("revGrandHenKg");

    const $revAddBtn = document.getElementById("revAddBtn");
    const $revCancelEditBtn = document.getElementById("revCancelEditBtn");
    const $revEditHint = document.getElementById("revEditHint");
    const $revClearBtn = document.getElementById("revClearBtn");
    const $revExportBtn = document.getElementById("revExportBtn");

    // =================== Orders DOM ===================
    const $orderCard = document.getElementById("orderCard");
    const $orderDate = document.getElementById("orderDate");
    const $orderLunarDate = document.getElementById("orderLunarDate");
    const $customer = document.getElementById("customer");
    const $phone = document.getElementById("phone");
    const $status = document.getElementById("status");
    const $orderContent = document.getElementById("orderContent");
    const $orderNote = document.getElementById("orderNote");
    const $orderCount = document.getElementById("orderCount");
    const $orderTbody = document.getElementById("orderTbody");

    const $addOrderBtn = document.getElementById("addOrderBtn");
    const $cancelOrderEditBtn = document.getElementById("cancelOrderEditBtn");
    const $orderEditHint = document.getElementById("orderEditHint");
    const $clearOrderBtn = document.getElementById("clearOrderBtn");
    const $exportOrderBtn = document.getElementById("exportOrderBtn");

    // =================== Damage DOM ===================
    const $damageCard = document.getElementById("damageCard");
    const $damDate = document.getElementById("damDate");

    const $damRoosterCount = document.getElementById("damRoosterCount");
    const $damRoosterKg = document.getElementById("damRoosterKg");
    const $damRoosterPrice = document.getElementById("damRoosterPrice");

    const $damHenCount = document.getElementById("damHenCount");
    const $damHenKg = document.getElementById("damHenKg");
    const $damHenPrice = document.getElementById("damHenPrice");

    const $damTotalCount = document.getElementById("damTotalCount");
    const $damTotalKg = document.getElementById("damTotalKg");
    const $damAmount = document.getElementById("damAmount");

    const $damTbody = document.getElementById("damTbody");

    const $damGrandTotal = document.getElementById("damGrandTotal");
    const $damGrandKg = document.getElementById("damGrandKg");
    const $damGrandRoosterKg = document.getElementById("damGrandRoosterKg");
    const $damGrandHenKg = document.getElementById("damGrandHenKg");
    const $damGrandCount = document.getElementById("damGrandCount");
    const $damGrandRoosterCount = document.getElementById("damGrandRoosterCount");
    const $damGrandHenCount = document.getElementById("damGrandHenCount");

    const $damAddBtn = document.getElementById("damAddBtn");
    const $damCancelEditBtn = document.getElementById("damCancelEditBtn");
    const $damEditHint = document.getElementById("damEditHint");
    const $damClearBtn = document.getElementById("damClearBtn");
    const $damExportBtn = document.getElementById("damExportBtn");

    // =================== Init dates ===================
    (function initDates(){
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,"0");
      const dd = String(today.getDate()).padStart(2,"0");
      const hh = String(today.getHours()).padStart(2,"0");
      const mi = String(today.getMinutes()).padStart(2,"0");

      $revDate.value = `${yyyy}-${mm}-${dd}`;
      $damDate.value = `${yyyy}-${mm}-${dd}`;
      $orderDate.value = `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    })();

    // =================== Auto lunar sync (Revenue) ===================
    let revLastAutoLunar = "";
    function revSyncLunar(){
      const auto = fmtLunarFromISODate($revDate.value);
      if(!$revLunarDate.value || $revLunarDate.value === revLastAutoLunar){
        $revLunarDate.value = auto;
      }
      revLastAutoLunar = auto;
    }
    $revDate.addEventListener("change", revSyncLunar);
    revSyncLunar();

    // =================== Auto lunar sync (Orders) ===================
    let orderLastAutoLunar = "";
    function orderSyncLunar(){
      const auto = fmtLunarFromDateTimeLocal($orderDate.value);
      if(!$orderLunarDate.value || $orderLunarDate.value === orderLastAutoLunar){
        $orderLunarDate.value = auto;
      }
      orderLastAutoLunar = auto;
    }
    $orderDate.addEventListener("change", orderSyncLunar);
    orderSyncLunar();

    // =================== State ===================
    let revenueRows = [];
    let orders = [];
    let damageRows = [];

    let revEditingIndex = null;
    let orderEditingIndex = null;
    let damEditingIndex = null;

    // =================== Persistence load/save ===================
    function saveRevenue(){ localStorage.setItem(LS_REVENUE, JSON.stringify(revenueRows)); }
    function loadRevenue(){
      try{
        const raw = localStorage.getItem(LS_REVENUE);
        revenueRows = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(revenueRows)) revenueRows = [];
      }catch{ revenueRows = []; }

      revenueRows = revenueRows.map(r => ({
        date: r?.date ?? "",
        lunarDate: r?.lunarDate ?? "",
        customerName: r?.customerName ?? "",

        roosterCount: toInt(r?.roosterCount),
        roosterKg: toKg(r?.roosterKg),
        roosterPrice: toNum(r?.roosterPrice),

        henCount: toInt(r?.henCount),
        henKg: toKg(r?.henKg),
        henPrice: toNum(r?.henPrice),

        labor: toNum(r?.labor),
        // null = dùng mặc định (Tổng cộng)
        received: (r?.received === null || r?.received === undefined) ? null : toNum(r?.received),
      }));
    }

    function saveOrders(){ localStorage.setItem(LS_ORDERS, JSON.stringify(orders)); }
    function loadOrders(){
      try{
        const raw = localStorage.getItem(LS_ORDERS);
        orders = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(orders)) orders = [];
      }catch{ orders = []; }

      orders = orders.map(o => ({
        orderDate: o?.orderDate ?? "",
        lunarDate: o?.lunarDate ?? (o?.orderDate ? fmtLunarFromDateTimeLocal(o.orderDate) : ""),
        customer: o?.customer ?? "",
        phone: o?.phone ?? "",
        status: o?.status ?? "Mới",
        content: o?.content ?? "",
        note: o?.note ?? "",
      }));
    }

    function saveDamage(){ localStorage.setItem(LS_DAMAGE, JSON.stringify(damageRows)); }
    function loadDamage(){
      try{
        const raw = localStorage.getItem(LS_DAMAGE);
        damageRows = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(damageRows)) damageRows = [];
      }catch{ damageRows = []; }

      damageRows = damageRows.map(d => ({
        date: d?.date ?? "",
        roosterCount: toInt(d?.roosterCount),
        roosterKg: toKg(d?.roosterKg),
        roosterPrice: toNum(d?.roosterPrice), // có thể 0

        henCount: toInt(d?.henCount),
        henKg: toKg(d?.henKg),
        henPrice: toNum(d?.henPrice), // có thể 0
      }));
    }

    // =================== UI state helpers ===================
    function setRevEditing(on){
      $revCancelEditBtn.style.display = on ? "" : "none";
      $revEditHint.style.display = on ? "" : "none";
      $revAddBtn.textContent = on ? "Cập nhật" : "+ Thêm dòng";
    }
    function setOrderEditing(on){
      $cancelOrderEditBtn.style.display = on ? "" : "none";
      $orderEditHint.style.display = on ? "" : "none";
      $addOrderBtn.textContent = on ? "Cập nhật" : "+ Thêm note";
    }
    function setDamEditing(on){
      $damCancelEditBtn.style.display = on ? "" : "none";
      $damEditHint.style.display = on ? "" : "none";
      $damAddBtn.textContent = on ? "Cập nhật" : "+ Thêm dòng";
    }

    function resetRevForm(){
      $revCustomerName.value = "";
      revSyncLunar();

      $revRoosterCount.value = 0;
      $revRoosterKg.value = 0;
      $revRoosterPrice.value = "";

      $revHenCount.value = 0;
      $revHenKg.value = 0;
      $revHenPrice.value = "";

      $revLabor.value = "";
      $revReceived.value = "";

      revCalcPreview();
    }
    function resetOrderForm(){
      orderSyncLunar();
      $customer.value = "";
      $phone.value = "";
      $status.value = "Mới";
      $orderContent.value = "";
      $orderNote.value = "";
    }
    function resetDamForm(){
      $damRoosterCount.value = 0;
      $damRoosterKg.value = 0;
      $damRoosterPrice.value = "";

      $damHenCount.value = 0;
      $damHenKg.value = 0;
      $damHenPrice.value = "";

      damCalcPreview();
    }

    // =================== Revenue preview calc ===================
    function revChickenMoneyCalc(){
      const rKg = toKg($revRoosterKg.value);
      const hKg = toKg($revHenKg.value);
      const rP = toNum($revRoosterPrice.value);
      const hP = toNum($revHenPrice.value);
      return (rKg * rP) + (hKg * hP);
    }
    function revCalcPreview(){
      const rC = toInt($revRoosterCount.value);
      const hC = toInt($revHenCount.value);
      const rKg = toKg($revRoosterKg.value);
      const hKg = toKg($revHenKg.value);

      const labor = toNum($revLabor.value);
      const chicken = revChickenMoneyCalc();
      const totalAll = chicken + labor;

      $revTotalCount.value = fmtCon(rC + hC);
      $revTotalKg.value = fmtKg(rKg + hKg);
      $revChickenMoney.value = fmtMoney(chicken);
      $revTotalAll.value = fmtMoney(totalAll);
    }
    [$revRoosterCount,$revHenCount,$revRoosterKg,$revHenKg,$revRoosterPrice,$revHenPrice,$revLabor].forEach(el => {
      el.addEventListener("input", revCalcPreview);
    });
    revCalcPreview();

    // =================== Damage preview calc ===================
    function damMoneyCalc(){
      const rKg = toKg($damRoosterKg.value);
      const hKg = toKg($damHenKg.value);
      const rP = toNum($damRoosterPrice.value); // có thể 0
      const hP = toNum($damHenPrice.value);     // có thể 0
      return (rKg * rP) + (hKg * hP);
    }
    function damCalcPreview(){
      const rC = toInt($damRoosterCount.value);
      const hC = toInt($damHenCount.value);
      const rKg = toKg($damRoosterKg.value);
      const hKg = toKg($damHenKg.value);

      $damTotalCount.value = fmtCon(rC + hC);
      $damTotalKg.value = fmtKg(rKg + hKg);
      $damAmount.value = fmtMoney(damMoneyCalc());
    }
    [$damRoosterCount,$damHenCount,$damRoosterKg,$damHenKg,$damRoosterPrice,$damHenPrice].forEach(el => {
      el.addEventListener("input", damCalcPreview);
    });
    damCalcPreview();

    // =================== Revenue data/validate ===================
    function getRevenueDataOrAlert(){
      const date = $revDate.value;
      const customerName = $revCustomerName.value.trim();
      const lunarRaw = $revLunarDate.value.trim();
      const lunarDate = lunarRaw || fmtLunarFromISODate(date);

      const roosterCount = toInt($revRoosterCount.value);
      const henCount = toInt($revHenCount.value);

      const roosterKg = toKg($revRoosterKg.value);
      const henKg = toKg($revHenKg.value);

      const roosterPrice = toNum($revRoosterPrice.value);
      const henPrice = toNum($revHenPrice.value);

      const labor = toNum($revLabor.value);

      const receivedRaw = String($revReceived.value ?? "").trim();
      const received = receivedRaw === "" ? null : toNum(receivedRaw);

      if(!date){ alert("Vui lòng chọn ngày (dương lịch)."); return null; }

      if(roosterKg + henKg <= 0){
        alert("Tổng kg phải > 0 (vì tính tiền theo kg).");
        return null;
      }
      // Doanh thu vẫn bắt đơn giá nếu có kg (vì cần tính tiền gà)
      if(roosterKg > 0 && roosterPrice <= 0){
        alert("Bạn nhập kg trống > 0 thì đơn giá trống phải > 0.");
        return null;
      }
      if(henKg > 0 && henPrice <= 0){
        alert("Bạn nhập kg mái > 0 thì đơn giá mái phải > 0.");
        return null;
      }

      return {
        date, lunarDate, customerName,
        roosterCount, roosterKg, roosterPrice,
        henCount, henKg, henPrice,
        labor,
        received
      };
    }

    // =================== Orders data/validate ===================
    function getOrderDataOrAlert(){
      const orderDate = $orderDate.value;
      const lunarRaw = $orderLunarDate.value.trim();
      const lunarDate = lunarRaw || fmtLunarFromDateTimeLocal(orderDate);

      const customer = $customer.value.trim();
      const phone = $phone.value.trim();
      const status = $status.value;
      const content = $orderContent.value.trim();
      const note = $orderNote.value.trim();

      if(!orderDate){ alert("Vui lòng chọn ngày đặt."); return null; }
      if(!customer && !phone){ alert("Nhập ít nhất Tên khách hoặc SĐT."); return null; }
      if(!content){ alert("Vui lòng nhập Nội dung đặt."); return null; }

      return { orderDate, lunarDate, customer, phone, status, content, note };
    }

    // =================== Damage data/validate ===================
    function getDamageDataOrAlert(){
      const date = $damDate.value;

      const roosterCount = toInt($damRoosterCount.value);
      const henCount = toInt($damHenCount.value);

      const roosterKg = toKg($damRoosterKg.value);
      const henKg = toKg($damHenKg.value);

      // NOTE: đơn giá CÓ THỂ bỏ trống => 0, KHÔNG validate bắt buộc
      const roosterPrice = toNum($damRoosterPrice.value);
      const henPrice = toNum($damHenPrice.value);

      if(!date){ alert("Vui lòng chọn ngày."); return null; }

      if(roosterKg + henKg <= 0){
        alert("Tổng kg thiệt hại phải > 0.");
        return null;
      }

      return { date, roosterCount, roosterKg, roosterPrice, henCount, henKg, henPrice };
    }

    // =================== Render Revenue ===================
    function renderRevenue(){
      $revTbody.innerHTML = "";

      let sumChicken = 0;
      let sumLabor = 0;
      let sumAll = 0;
      let sumReceived = 0;

      let sumCount = 0;
      let sumKg = 0;
      let sumRC = 0, sumHC = 0;
      let sumRK = 0, sumHK = 0;

      revenueRows.forEach((row, idx) => {
        const cSum = row.roosterCount + row.henCount;
        const kSum = row.roosterKg + row.henKg;

        const chicken = (row.roosterKg * row.roosterPrice) + (row.henKg * row.henPrice);
        const totalAll = chicken + row.labor;

        const received = (row.received === null ? totalAll : row.received);

        sumChicken += chicken;
        sumLabor += row.labor;
        sumAll += totalAll;
        sumReceived += received;

        sumCount += cSum;
        sumKg += kSum;
        sumRC += row.roosterCount;
        sumHC += row.henCount;
        sumRK += row.roosterKg;
        sumHK += row.henKg;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(row.date)}</td>
          <td>${esc(row.lunarDate || "")}</td>
          <td>${esc(row.customerName || "")}</td>

          <td class="num">${row.roosterCount}</td>
          <td class="num">${NF.format(row.roosterKg)}</td>
          <td class="num">${fmtMoney(row.roosterPrice)}</td>

          <td class="num">${row.henCount}</td>
          <td class="num">${NF.format(row.henKg)}</td>
          <td class="num">${fmtMoney(row.henPrice)}</td>

          <td class="num"><b>${cSum}</b></td>
          <td class="num"><b>${NF.format(kSum)}</b></td>

          <td class="num"><b>${fmtMoney(chicken)}</b></td>
          <td class="num">${fmtMoney(row.labor)}</td>
          <td class="num"><b>${fmtMoney(totalAll)}</b></td>
          <td class="num"><b>${fmtMoney(received)}</b></td>

          <td>
            <button class="btn-mini ok" data-rev-edit="${idx}">Sửa</button>
            <button class="btn-mini danger" data-rev-del="${idx}">Xoá</button>
          </td>
        `;
        $revTbody.appendChild(tr);
      });

      $revGrandReceived.textContent = fmtMoney(sumReceived);
      $revGrandChicken.textContent = fmtMoney(sumChicken);
      $revGrandLabor.textContent = fmtMoney(sumLabor);
      $revGrandAll.textContent = fmtMoney(sumAll);

      $revGrandCount.textContent = sumCount;
      $revGrandKg.textContent = NF.format(sumKg);
      $revGrandRoosterCount.textContent = sumRC;
      $revGrandHenCount.textContent = sumHC;
      $revGrandRoosterKg.textContent = NF.format(sumRK);
      $revGrandHenKg.textContent = NF.format(sumHK);
    }

    // =================== Render Orders ===================
    function renderOrders(){
      $orderTbody.innerHTML = "";
      $orderCount.textContent = orders.length;

      orders.forEach((o, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(o.orderDate || "")}</td>
          <td>${esc(o.lunarDate || "")}</td>
          <td>${esc(o.customer || "")}</td>
          <td>${esc(o.phone || "")}</td>
          <td>${esc(o.content || "")}</td>
          <td>${esc(o.note || "")}</td>
          <td><b>${esc(o.status || "Mới")}</b></td>
          <td>
            <button class="btn-mini ok" data-oedit="${idx}">Sửa</button>
            <button class="btn-mini danger" data-odel="${idx}">Xoá</button>
          </td>
        `;
        $orderTbody.appendChild(tr);
      });
    }

    // =================== Render Damage ===================
    function renderDamage(){
      $damTbody.innerHTML = "";

      let sumMoney = 0;
      let sumKg = 0;
      let sumRK = 0, sumHK = 0;
      let sumCount = 0;
      let sumRC = 0, sumHC = 0;

      const displayPrice = (p) => (p > 0 ? fmtMoney(p) : "—");

      damageRows.forEach((d, idx) => {
        const cSum = d.roosterCount + d.henCount;
        const kSum = d.roosterKg + d.henKg;

        const money = (d.roosterKg * d.roosterPrice) + (d.henKg * d.henPrice);

        sumMoney += money;
        sumKg += kSum;
        sumRK += d.roosterKg;
        sumHK += d.henKg;
        sumCount += cSum;
        sumRC += d.roosterCount;
        sumHC += d.henCount;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(d.date)}</td>

          <td class="num">${d.roosterCount}</td>
          <td class="num">${NF.format(d.roosterKg)}</td>
          <td class="num">${displayPrice(d.roosterPrice)}</td>

          <td class="num">${d.henCount}</td>
          <td class="num">${NF.format(d.henKg)}</td>
          <td class="num">${displayPrice(d.henPrice)}</td>

          <td class="num"><b>${cSum}</b></td>
          <td class="num"><b>${NF.format(kSum)}</b></td>
          <td class="num"><b>${fmtMoney(money)}</b></td>

          <td>
            <button class="btn-mini ok" data-dedit="${idx}">Sửa</button>
            <button class="btn-mini danger" data-ddel="${idx}">Xoá</button>
          </td>
        `;
        $damTbody.appendChild(tr);
      });

      $damGrandTotal.textContent = fmtMoney(sumMoney);
      $damGrandKg.textContent = NF.format(sumKg);
      $damGrandRoosterKg.textContent = NF.format(sumRK);
      $damGrandHenKg.textContent = NF.format(sumHK);

      $damGrandCount.textContent = sumCount;
      $damGrandRoosterCount.textContent = sumRC;
      $damGrandHenCount.textContent = sumHC;
    }

    // =================== Actions: Revenue ===================
    $revAddBtn.addEventListener("click", () => {
      const data = getRevenueDataOrAlert();
      if(!data) return;

      if(revEditingIndex === null) revenueRows.unshift(data);
      else revenueRows[revEditingIndex] = data;

      saveRevenue();
      renderRevenue();

      revEditingIndex = null;
      setRevEditing(false);
      resetRevForm();
      $revCustomerName.focus();
    });

    $revCancelEditBtn.addEventListener("click", () => {
      revEditingIndex = null;
      setRevEditing(false);
      resetRevForm();
    });

    $revTbody.addEventListener("click", (e) => {
      const delBtn = e.target.closest("button[data-rev-del]");
      const editBtn = e.target.closest("button[data-rev-edit]");

      if(delBtn){
        const idx = Number(delBtn.getAttribute("data-rev-del"));
        if(!Number.isFinite(idx)) return;

        if(revEditingIndex === idx){
          revEditingIndex = null;
          setRevEditing(false);
          resetRevForm();
        }

        revenueRows.splice(idx, 1);
        saveRevenue();
        renderRevenue();
        return;
      }

      if(editBtn){
        const idx = Number(editBtn.getAttribute("data-rev-edit"));
        if(!Number.isFinite(idx)) return;
        const r = revenueRows[idx];
        if(!r) return;

        revEditingIndex = idx;
        setRevEditing(true);

        $revDate.value = r.date || "";
        revSyncLunar();
        $revLunarDate.value = r.lunarDate || $revLunarDate.value;
        $revCustomerName.value = r.customerName || "";

        $revRoosterCount.value = r.roosterCount ?? 0;
        $revRoosterKg.value = r.roosterKg ?? 0;
        $revRoosterPrice.value = r.roosterPrice ?? "";

        $revHenCount.value = r.henCount ?? 0;
        $revHenKg.value = r.henKg ?? 0;
        $revHenPrice.value = r.henPrice ?? "";

        $revLabor.value = r.labor ? String(r.labor) : "";
        $revReceived.value = (r.received === null) ? "" : String(r.received);

        revCalcPreview();
        scrollToEl($revenueCard);
        $revCustomerName.focus();
      }
    });

    document.getElementById("revClearBtn").addEventListener("click", () => {
      if(!revenueRows.length) return;
      if(confirm("Xoá toàn bộ dữ liệu doanh thu?")){
        revenueRows = [];
        saveRevenue();
        renderRevenue();
        revEditingIndex = null;
        setRevEditing(false);
        resetRevForm();
      }
    });

    document.getElementById("revExportBtn").addEventListener("click", () => {
      const header = [
        "Ngay_duong_lich","Lich_am","Ten_khach_hang",
        "Trong_con","Trong_kg","Gia_trong_vnd_kg",
        "Mai_con","Mai_kg","Gia_mai_vnd_kg",
        "Tong_con","Tong_kg",
        "Tien_ga","Tien_cong","Tong_cong","Tien_nhan"
      ];
      const lines = [header.join(",")];
      const safe = (s) => String(s ?? "").replaceAll(",", " ");

      revenueRows.slice().reverse().forEach(r => {
        const cSum = r.roosterCount + r.henCount;
        const kSum = r.roosterKg + r.henKg;

        const chicken = (r.roosterKg * r.roosterPrice) + (r.henKg * r.henPrice);
        const totalAll = chicken + r.labor;
        const received = (r.received === null ? totalAll : r.received);

        lines.push([
          safe(r.date), safe(r.lunarDate), safe(r.customerName),
          r.roosterCount, r.roosterKg, r.roosterPrice,
          r.henCount, r.henKg, r.henPrice,
          cSum, kSum,
          chicken, r.labor, totalAll, received
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "doanh_thu_ban_ga.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // =================== Actions: Orders ===================
    $addOrderBtn.addEventListener("click", () => {
      const data = getOrderDataOrAlert();
      if(!data) return;

      if(orderEditingIndex === null) orders.unshift(data);
      else orders[orderEditingIndex] = data;

      saveOrders();
      renderOrders();

      orderEditingIndex = null;
      setOrderEditing(false);
      resetOrderForm();
      $customer.focus();
    });

    $cancelOrderEditBtn.addEventListener("click", () => {
      orderEditingIndex = null;
      setOrderEditing(false);
      resetOrderForm();
    });

    $orderTbody.addEventListener("click", (e) => {
      const delBtn = e.target.closest("button[data-odel]");
      const editBtn = e.target.closest("button[data-oedit]");

      if(delBtn){
        const idx = Number(delBtn.getAttribute("data-odel"));
        if(!Number.isFinite(idx)) return;

        if(orderEditingIndex === idx){
          orderEditingIndex = null;
          setOrderEditing(false);
          resetOrderForm();
        }

        orders.splice(idx, 1);
        saveOrders();
        renderOrders();
        return;
      }

      if(editBtn){
        const idx = Number(editBtn.getAttribute("data-oedit"));
        if(!Number.isFinite(idx)) return;
        const o = orders[idx];
        if(!o) return;

        orderEditingIndex = idx;
        setOrderEditing(true);

        $orderDate.value = o.orderDate || "";
        orderSyncLunar();
        $orderLunarDate.value = o.lunarDate || $orderLunarDate.value;

        $customer.value = o.customer || "";
        $phone.value = o.phone || "";
        $status.value = o.status || "Mới";
        $orderContent.value = o.content || "";
        $orderNote.value = o.note || "";

        scrollToEl($orderCard);
        $customer.focus();
      }
    });

    $clearOrderBtn.addEventListener("click", () => {
      if(!orders.length) return;
      if(confirm("Xoá toàn bộ note đặt hàng?")){
        orders = [];
        saveOrders();
        renderOrders();
        orderEditingIndex = null;
        setOrderEditing(false);
        resetOrderForm();
      }
    });

    $exportOrderBtn.addEventListener("click", () => {
      const header = ["Ngay_dat","Lich_am","Khach","SDT","Noi_dung","Ghi_chu","Trang_thai"];
      const lines = [header.join(",")];
      const safe = (s) => String(s ?? "").replaceAll(",", " ");

      orders.slice().reverse().forEach(o => {
        lines.push([
          safe(o.orderDate), safe(o.lunarDate),
          safe(o.customer), safe(o.phone),
          safe(o.content), safe(o.note),
          safe(o.status)
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "note_dat_hang.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // =================== Actions: Damage ===================
    $damAddBtn.addEventListener("click", () => {
      const data = getDamageDataOrAlert();
      if(!data) return;

      if(damEditingIndex === null) damageRows.unshift(data);
      else damageRows[damEditingIndex] = data;

      saveDamage();
      renderDamage();

      damEditingIndex = null;
      setDamEditing(false);
      resetDamForm();
      $damRoosterCount.focus();
    });

    $damCancelEditBtn.addEventListener("click", () => {
      damEditingIndex = null;
      setDamEditing(false);
      resetDamForm();
    });

    $damTbody.addEventListener("click", (e) => {
      const delBtn = e.target.closest("button[data-ddel]");
      const editBtn = e.target.closest("button[data-dedit]");

      if(delBtn){
        const idx = Number(delBtn.getAttribute("data-ddel"));
        if(!Number.isFinite(idx)) return;

        if(damEditingIndex === idx){
          damEditingIndex = null;
          setDamEditing(false);
          resetDamForm();
        }

        damageRows.splice(idx, 1);
        saveDamage();
        renderDamage();
        return;
      }

      if(editBtn){
        const idx = Number(editBtn.getAttribute("data-dedit"));
        if(!Number.isFinite(idx)) return;
        const d = damageRows[idx];
        if(!d) return;

        damEditingIndex = idx;
        setDamEditing(true);

        $damDate.value = d.date || "";

        $damRoosterCount.value = d.roosterCount ?? 0;
        $damRoosterKg.value = d.roosterKg ?? 0;
        $damRoosterPrice.value = d.roosterPrice ? String(d.roosterPrice) : "";

        $damHenCount.value = d.henCount ?? 0;
        $damHenKg.value = d.henKg ?? 0;
        $damHenPrice.value = d.henPrice ? String(d.henPrice) : "";

        damCalcPreview();
        scrollToEl($damageCard);
        $damRoosterCount.focus();
      }
    });

    $damClearBtn.addEventListener("click", () => {
      if(!damageRows.length) return;
      if(confirm("Xoá toàn bộ bảng thiệt hại?")){
        damageRows = [];
        saveDamage();
        renderDamage();
        damEditingIndex = null;
        setDamEditing(false);
        resetDamForm();
      }
    });

    $damExportBtn.addEventListener("click", () => {
      const header = [
        "Ngay",
        "Trong_con","Trong_kg","Gia_trong_vnd_kg",
        "Mai_con","Mai_kg","Gia_mai_vnd_kg",
        "Tong_con","Tong_kg","Tong_tien"
      ];
      const lines = [header.join(",")];

      damageRows.slice().reverse().forEach(d => {
        const cSum = d.roosterCount + d.henCount;
        const kSum = d.roosterKg + d.henKg;
        const money = (d.roosterKg * d.roosterPrice) + (d.henKg * d.henPrice);

        lines.push([
          d.date,
          d.roosterCount, d.roosterKg, d.roosterPrice,
          d.henCount, d.henKg, d.henPrice,
          cSum, kSum, money
        ].join(","));
      });

      const blob = new Blob([lines.join("\n")], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "thiet_hai_ban_ga.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // =================== Start ===================
    loadRevenue();
    loadOrders();
    loadDamage();

    renderRevenue();
    renderOrders();
    renderDamage();

    setRevEditing(false);
    setOrderEditing(false);
    setDamEditing(false);

    revSyncLunar();
    orderSyncLunar();
    revCalcPreview();
    damCalcPreview();
  </script>
</body>
</html>
